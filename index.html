<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ’¼ Daddy's Real DeFi Vault</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4"></script>
  <style>
    body {
      background: #0d0d0d;
      color: #00ffcc;
      font-family: monospace;
      padding: 20px;
    }
    h1 {
      color: #00ffff;
    }
    .timestamp {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 16px;
      font-weight: bold;
      color: #00ffff;
      margin: 20px 0 10px;
    }
    .box {
      background: #111;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #222;
      transition: background-color 0.5s ease;
    }
    .gain {
      font-weight: bold;
      color: #00ffcc;
    }
    .positive { color: #00ff00; }
    .negative { color: #ff4444; }
    .flash-up { background-color: #003300 !important; }
    .flash-down { background-color: #330000 !important; }
    #chartContainer { margin-top: 50px; }
    .error { color: #ff4444; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ðŸ’¼ Daddy's Real DeFi Vault</h1>
  <div class="timestamp" id="timestamp">Loading...</div>

  <div class="section">
    <div class="section-title">Stablecoin Portfolio</div>
    <div id="stable">Loading...</div>
  </div>

  <div class="section">
    <div class="section-title">Heaven's Vault Portfolio</div>
    <div id="heaven">Loading...</div>
  </div>

  <div id="chartContainer">
    <div class="section-title">Combined Portfolio Performance</div>
    <canvas id="vaultChart" width="600" height="100"></canvas>
  </div>

  <div class="section">
    <div class="section-title">Stablecoin Performance</div>
    <canvas id="stableChart" width="600" height="100"></canvas>
  </div>

  <div class="section">
    <div class="section-title">Heaven's Vault Performance</div>
    <canvas id="heavenChart" width="600" height="100"></canvas>
  </div>

  <script>
    console.log("Script started");

    const stableTokens = {
      'USDE': 'ethena-usde',
      'RAI': 'rai',
      'FRAX': 'frax',
      'ALUSD': 'alchemix-usd',
      'LUSD': 'liquity-usd'
    };

    const heavenTokens = {
      'ETHENA': 'ethena',
      'PENDLE': 'pendle',
      'GMX': 'gmx',
      'LIT': 'litentry',
      'METH': 'mantle-staked-ether'
    };

    let previousPrices = {};
    let holdings = { stable: {}, heaven: {} };
    let performanceHistory = { stable: [], heaven: [], combined: [] };
    let chart, stableChart, heavenChart;

    function saveHoldings() {
      const snapshot = { holdings, timestamp: new Date().toISOString(), history: performanceHistory };
      localStorage.setItem('daddyVaultHoldings', JSON.stringify(snapshot));
    }

    function loadHoldings() {
      const saved = localStorage.getItem('daddyVaultHoldings');
      if (saved) {
        const parsed = JSON.parse(saved);
        holdings = parsed.holdings || { stable: {}, heaven: {} };
        performanceHistory = parsed.history || { stable: [], heaven: [], combined: [] };
      }
    }

    async function fetchPrices(tokens) {
      const ids = [...new Set(Object.values(tokens))].join(',');
      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=gbp`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return await res.json();
      } catch (error) {
        console.error('Error fetching prices:', error);
        throw error;
      }
    }

    async function update() {
      try {
        const allTokens = { ...stableTokens, ...heavenTokens };
        const prices = await fetchPrices(allTokens);

        document.getElementById('timestamp').textContent = new Date().toLocaleString();

        let stableHtml = '', stableTotal = 0;
        for (const token in stableTokens) {
          const id = stableTokens[token];
          const price = prices[id]?.gbp || 0;
          const holding = holdings.stable[token] || 0;
          const value = holding * price;
          stableTotal += value;
          const previousPrice = previousPrices[token] || price;
          const change = previousPrice ? ((price - previousPrice) / previousPrice * 100).toFixed(2) : '0.00';
          const gainClass = price > previousPrice ? 'positive' : price < previousPrice ? 'negative' : '';
          const flashClass = price > previousPrice ? 'flash-up' : price < previousPrice ? 'flash-down' : '';
          stableHtml += `
            <div class="box ${flashClass}">
              ${token}: ${holding} tokens @ Â£${price.toFixed(2)} = Â£${value.toFixed(2)}
              <span class="gain ${gainClass}">(${change}%)</span>
            </div>
          `;
          previousPrices[token] = price;
        }
        stableHtml += `<div class="box">Total Stablecoin Value: Â£${stableTotal.toFixed(2)}</div>`;
        document.getElementById('stable').innerHTML = stableHtml;

        let heavenHtml = '', heavenTotal = 0;
        for (const token in heavenTokens) {
          const id = heavenTokens[token];
          const price = prices[id]?.gbp || 0;
          const holding = holdings.heaven[token] || 0;
          const value = holding * price;
          heavenTotal += value;
          const previousPrice = previousPrices[token] || price;
          const change = previousPrice ? ((price - previousPrice) / previousPrice * 100).toFixed(2) : '0.00';
          const gainClass = price > previousPrice ? 'positive' : price < previousPrice ? 'negative' : '';
          const flashClass = price > previousPrice ? 'flash-up' : price < previousPrice ? 'flash-down' : '';
          heavenHtml += `
            <div class="box ${flashClass}">
              ${token}: ${holding} tokens @ Â£${price.toFixed(2)} = Â£${value.toFixed(2)}
              <span class="gain ${gainClass}">(${change}%)</span>
            </div>
          `;
          previousPrices[token] = price;
        }
        heavenHtml += `<div class="box">Total Heaven's Vault Value: Â£${heavenTotal.toFixed(2)}</div>`;
        document.getElementById('heaven').innerHTML = heavenHtml;

        const combinedTotal = stableTotal + heavenTotal;
        const now = new Date();
        performanceHistory.stable.push({ timestamp: now, value: stableTotal });
        performanceHistory.heaven.push({ timestamp: now, value: heavenTotal });
        performanceHistory.combined.push({ timestamp: now, value: combinedTotal });

        if (performanceHistory.stable.length > 100) {
          performanceHistory.stable.shift();
          performanceHistory.heaven.shift();
          performanceHistory.combined.shift();
        }

        updateChart(stableChart, performanceHistory.stable);
        updateChart(heavenChart, performanceHistory.heaven);
        updateChart(chart, performanceHistory.combined);

        setTimeout(() => {
          document.querySelectorAll('.flash-up, .flash-down').forEach(el => {
            el.classList.remove('flash-up', 'flash-down');
          });
        }, 1000);

        saveHoldings();
      } catch (error) {
        document.getElementById('stable').innerHTML = '<div class="error">Error fetching stablecoin data</div>';
        document.getElementById('heaven').innerHTML = '<div class="error">Error fetching Heaven\'s Vault data</div>';
        console.error('Update failed:', error);
      }
    }

    function updateChart(chartInstance, data) {
      chartInstance.data.datasets[0].data = data.map(d => ({ x: d.timestamp, y: d.value }));
      chartInstance.update();
    }

    function initCharts() {
      const chartOptions = {
        type: 'line',
        data: {
          datasets: [{ label: 'Value', data: [], borderColor: '#00ffcc', fill: false }]
        },
        options: {
          scales: {
            x: { type: 'time', time: { unit: 'minute' } },
            y: { beginAtZero: false }
          }
        }
      };

      stableChart = new Chart(document.getElementById('stableChart'), {
        ...chartOptions,
        data: { ...chartOptions.data, datasets: [{ ...chartOptions.data.datasets[0], label: 'Stablecoin Value' }] }
      });
      heavenChart = new Chart(document.getElementById('heavenChart'), {
        ...chartOptions,
        data: { ...chartOptions.data, datasets: [{ ...chartOptions.data.datasets[0], label: "Heaven's Vault Value" }] }
      });
      chart = new Chart(document.getElementById('vaultChart'), {
        ...chartOptions,
        data: { ...chartOptions.data, datasets: [{ ...chartOptions.data.datasets[0], label: 'Combined Portfolio Value' }] }
      });
    }

    loadHoldings();
    initCharts();
    setInterval(update, 10000);
    update();
  </script>
</body>
</html>
