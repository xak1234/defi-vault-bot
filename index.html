<script>
  const START_STABLE = 5000;
  const START_HEAVEN = 5000;

  const stableTokens = {
    'USDE': 'ethena-usde',
    'RAI': 'rai',
    'FRAX': 'frax',
    'ALUSD': 'alchemix-usd',
    'LUSD': 'liquity-usd'
  };

  const heavenTokens = {
    'ETHENA': 'ethena-usde',
    'PENDLE': 'pendle',
    'GMX': 'gmx',
    'LIT': 'litentry',
    'METH': 'mantle-staked-ether'
  };

  async function fetchPrices(tokens) {
    const ids = Object.values(tokens).join(',');
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=gbp`;

    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch (err) {
      console.error("‚ùå Failed to fetch prices:", err);
      return {}; // Return empty object as fallback
    }
  }

  function calculate(tokens, prices, start) {
    const split = start / Object.keys(tokens).length;
    let total = 0;
    const tokenHTML = [];

    for (const [symbol, id] of Object.entries(tokens)) {
      const price = prices[id]?.gbp ?? 1; // Fallback to ¬£1
      const qty = split / price;
      const value = qty * price;
      total += value;

      tokenHTML.push(`
        <div class="box">${symbol} Price<br>¬£${price.toFixed(6)}</div>
      `);
    }

    const gain = total - start;
    const gainClass = gain >= 0 ? 'positive' : 'negative';
    const totalBox = `<div class="box">Total Value<br>¬£${total.toFixed(2)}</div>`;
    const gainBox = `<div class="gain ${gainClass}">Gain<br>¬£${gain.toFixed(2)}</div>`;

    return totalBox + tokenHTML.join('') + gainBox;
  }

  async function updateVault() {
    const stablePrices = await fetchPrices(stableTokens);
    const heavenPrices = await fetchPrices(heavenTokens);

    console.log("üîÅ Stable prices:", stablePrices);
    console.log("üîÅ Heaven prices:", heavenPrices);

    const stableHTML = calculate(stableTokens, stablePrices, START_STABLE);
    const heavenHTML = calculate(heavenTokens, heavenPrices, START_HEAVEN);

    document.getElementById("stable").innerHTML = stableHTML;
    document.getElementById("heaven").innerHTML = heavenHTML;

    const now = new Date().toUTCString();
    document.getElementById("timestamp").textContent = `Last updated: ${now}`;
  }

  // First load + refresh every 60 seconds
  setInterval(updateVault, 60000);
  window.onload = updateVault;
</script>
