<!DOCTYPE html>
<html>
<head>
  <title>ðŸ’¼ Daddy's Real DeFi Vault</title>
  <meta charset="UTF-8">
  <style>
    body {
      background: #0d0d0d;
      color: #00ffcc;
      font-family: monospace;
      padding: 20px;
    }
    h1 {
      color: #00ffff;
    }
    .timestamp {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 16px;
      font-weight: bold;
      color: #00ffff;
      margin: 20px 0 10px;
    }
    .box {
      background: #111;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #222;
      transition: background-color 0.5s ease;
    }
    .gain {
      font-weight: bold;
      color: #00ffcc;
    }
    .positive {
      color: #00ff00;
    }
    .negative {
      color: #ff4444;
    }
    .flash-up {
      background-color: #003300 !important;
    }
    .flash-down {
      background-color: #330000 !important;
    }
  </style>
</head>
<body>
  <h1>ðŸ’¼ Daddy's Real DeFi Vault</h1>
  <div class="timestamp" id="timestamp">Loading...</div>

  <div class="section">
    <div class="section-title">Stablecoin Portfolio</div>
    <div id="stable">Loading...</div>
  </div>

  <div class="section">
    <div class="section-title">Heaven's Vault Portfolio</div>
    <div id="heaven">Loading...</div>
  </div>

  <script>
    const stableTokens = {
      'USDE': 'ethena-usde',
      'RAI': 'rai',
      'FRAX': 'frax',
      'ALUSD': 'alchemix-usd',
      'LUSD': 'liquity-usd'
    };

    const heavenTokens = {
      'ETHENA': 'ethena-usde',
      'PENDLE': 'pendle',
      'GMX': 'gmx',
      'LIT': 'litentry',
      'METH': 'mantle-staked-ether'
    };

    let previousPrices = {};
    let holdings = { stable: {}, heaven: {} };

    function saveHoldings() {
      localStorage.setItem('daddyVaultHoldings', JSON.stringify(holdings));
    }

    function loadHoldings() {
      const saved = localStorage.getItem('daddyVaultHoldings');
      if (saved) {
        holdings = JSON.parse(saved);
      }
    }

    async function fetchPrices(tokens) {
      const ids = [...new Set(Object.values(tokens))].join(',');
      const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=gbp`);
      if (!res.ok) throw new Error('Price fetch failed');
      return await res.json();
    }

    function updateBox(id, price) {
      const el = document.getElementById(id);
      if (!el) return;
      const prev = previousPrices[id];
      if (prev !== undefined) {
        if (price > prev) el.classList.add("flash-up");
        else if (price < prev) el.classList.add("flash-down");
        setTimeout(() => el.classList.remove("flash-up", "flash-down"), 1500);
      }
      el.innerHTML = `Â£${price.toFixed(6)}`;
      previousPrices[id] = price;
    }

    function calculateValue(tokens, prices, store, prefix) {
      let total = 0;
      let html = '';

      for (const [symbol, id] of Object.entries(tokens)) {
        const price = prices[id]?.gbp ?? previousPrices[`${prefix}-${symbol}`] ?? 0;

        if (!store[symbol]) continue;

        const qty = store[symbol].quantity;
        const value = qty * price;
        total += value;

        const boxId = `${prefix}-${symbol}`;
        html += `
          <div class="box">
            ${symbol} Price<br>
            <div id="${boxId}">Â£${price.toFixed(6)}</div>
          </div>
        `;

        setTimeout(() => updateBox(boxId, price), 0);
      }

      const invested = Object.values(store).reduce((sum, t) => sum + (t.priceBought * t.quantity), 0);
      const gain = total - invested;
      const gainClass = gain >= 0 ? 'positive' : 'negative';

      return `
        <div class="box">Total Value<br>Â£${total.toFixed(2)}</div>
        ${html}
        <div class="gain ${gainClass}">Gain<br>Â£${gain.toFixed(2)} (${((gain / invested) * 100).toFixed(2)}%)</div>
      `;
    }

    async function updateVault() {
      try {
        const allTokens = { ...stableTokens, ...heavenTokens };
        const prices = await fetchPrices(allTokens);

        // Init if not set
        for (const [symbol, id] of Object.entries(stableTokens)) {
          if (!holdings.stable[symbol]) {
            const qty = 5000 / Object.keys(stableTokens).length / prices[id].gbp;
            holdings.stable[symbol] = { quantity: qty, priceBought: prices[id].gbp };
          }
        }

        for (const [symbol, id] of Object.entries(heavenTokens)) {
          if (!holdings.heaven[symbol]) {
            const qty = 5000 / Object.keys(heavenTokens).length / prices[id].gbp;
            holdings.heaven[symbol] = { quantity: qty, priceBought: prices[id].gbp };
          }
        }

        saveHoldings();

        document.getElementById("stable").innerHTML = calculateValue(stableTokens, prices, holdings.stable, 'stable');
        document.getElementById("heaven").innerHTML = calculateValue(heavenTokens, prices, holdings.heaven, 'heaven');
        document.getElementById("timestamp").textContent = "Last updated: " + new Date().toUTCString();
      } catch (e) {
        console.error(e);
        document.getElementById("timestamp").textContent = "Last update failed: " + new Date().toUTCString();
      }
    }

    loadHoldings();
    updateVault();
    setInterval(updateVault, 300000);
  </script>
</body>
</html>
