<script>
  const START_STABLE = 5000;
  let winnings = parseFloat(localStorage.getItem("winnings")) || 0;
  let startHeaven = parseFloat(localStorage.getItem("startHeaven"));
  if (isNaN(startHeaven)) startHeaven = 5000;

  const stableTokens = {
    'USDE': 'ethena-usde',
    'RAI': 'rai',
    'FRAX': 'frax',
    'ALUSD': 'alchemix-usd',
    'LUSD': 'liquity-usd'
  };

  const heavenTokens = {
    'ETHENA': 'ethena-usde',
    'PENDLE': 'pendle',
    'GMX': 'gmx',
    'LIT': 'litentry',
    'METH': 'mantle-staked-ether'
  };

  const debugBox = document.createElement('div');
  debugBox.style.fontSize = '12px';
  debugBox.style.color = '#888';
  debugBox.style.marginTop = '20px';
  document.body.appendChild(debugBox);

  let heavenHistory = [];
  let stableHistory = [];

  async function fetchPrices(tokens) {
    const ids = Object.values(tokens).join(',');
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=gbp`;

    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (!Object.keys(data).length) throw new Error("Empty price data");
      return data;
    } catch (err) {
      console.error("‚ùå Fetch error:", err);
      return null;
    }
  }

  function calculate(tokens, prices, start, label) {
    const split = start / Object.keys(tokens).length;
    let total = 0;
    const html = [];

    for (const [symbol, id] of Object.entries(tokens)) {
      const price = prices && prices[id]?.gbp;
      if (price) {
        const qty = split / price;
        const value = qty * price;
        total += value;
        html.push(`<div class="box">${symbol} Price<br>¬£${price.toFixed(6)}</div>`);
      } else {
        html.push(`<div class="box">${symbol} Price<br>Unavailable</div>`);
      }
    }

    const gain = total - start;
    const gainClass = gain >= 0 ? 'positive' : 'negative';
    return {
      html: `
        <div class="box">Total Value<br>¬£${total.toFixed(2)}</div>
        ${html.join('')}
        <div class="gain ${gainClass}">Gain<br>¬£${gain.toFixed(2)}</div>
      `,
      total,
      gain
    };
  }

  function updateChart(chart, label, data) {
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(data);
    if (chart.data.labels.length > 20) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();
  }

  let heavenChart = new Chart(document.getElementById('heavenChart').getContext('2d'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: "Heaven's Vault (¬£)",
        borderColor: '#ff00ff',
        data: []
      }]
    },
    options: {
      plugins: { legend: { labels: { color: '#00ffff' } } },
      scales: {
        x: { ticks: { color: '#888' } },
        y: { ticks: { color: '#888' } }
      }
    }
  });

  let stableChart = new Chart(document.getElementById('stableChart').getContext('2d'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: "Stablecoin Vault (¬£)",
        borderColor: '#00ffcc',
        data: []
      }]
    },
    options: {
      plugins: { legend: { labels: { color: '#00ffff' } } },
      scales: {
        x: { ticks: { color: '#888' } },
        y: { ticks: { color: '#888' } }
      }
    }
  });

  async function updateVault() {
    try {
      const stablePrices = await fetchPrices(stableTokens);
      const heavenPrices = await fetchPrices(heavenTokens);

      const stableData = calculate(stableTokens, stablePrices, START_STABLE, "Stablecoin");
      const heavenData = calculate(heavenTokens, heavenPrices, startHeaven, "Heaven");

      if (heavenData.gain >= 50) {
        winnings += heavenData.gain;
        startHeaven = heavenData.total;
        localStorage.setItem("winnings", winnings.toFixed(2));
        localStorage.setItem("startHeaven", heavenData.total.toFixed(2));
        console.log(`üéâ Winnings triggered: +¬£${heavenData.gain.toFixed(2)}`);
      }

      document.getElementById("stable").innerHTML = stableData.html;
      document.getElementById("heaven").innerHTML = heavenData.html;
      document.getElementById("winnings").innerHTML = `¬£${winnings.toFixed(2)}`;
      document.getElementById("timestamp").textContent = "Last updated: " + new Date().toUTCString();

      updateChart(heavenChart, new Date().toLocaleTimeString(), heavenData.total);
      updateChart(stableChart, new Date().toLocaleTimeString(), stableData.total);

      debugBox.innerText = '‚úÖ Prices loaded and vaults updated successfully.';
    } catch (e) {
      console.error('üî• updateVault() error:', e);
      debugBox.innerText = '‚ö†Ô∏è Failed to load data. Try again later.';
      document.getElementById("heaven").innerHTML = '<div class="box">Failed to load Heaven‚Äôs Vault data.</div>';
    }
  }

  function resetWinnings() {
    winnings = 0;
    startHeaven = 5000;
    localStorage.removeItem("winnings");
    localStorage.removeItem("startHeaven");
    updateVault();
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateVault();
    setInterval(updateVault, 5000);
  });
</script>
