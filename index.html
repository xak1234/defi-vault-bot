<!DOCTYPE html>
<html>
<head>
  <title>üíº Daddy's Live DeFi Vault</title>
  <meta charset="UTF-8">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #0d0d0d;
      color: #00ffcc;
      font-family: monospace;
      padding: 20px;
    }
    h1 {
      color: #00ffff;
    }
    .timestamp {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 20px;
    }
    .section {
      margin-bottom: 40px;
    }
    .section-title {
      font-size: 16px;
      font-weight: bold;
      color: #00ffff;
      margin-bottom: 10px;
    }
    .box {
      background: #111;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #222;
    }
    .gain {
      font-weight: bold;
      color: #00ffcc;
      margin-top: 10px;
    }
    .positive {
      color: #00ff00;
    }
    .negative {
      color: #ff4444;
    }
  </style>
</head>
<body>
  <h1>üíº Daddy's Live DeFi Vault</h1>
  <div class="timestamp" id="timestamp">Loading...</div>

  <div class="section">
    <div class="section-title">Stablecoin Portfolio</div>
    <div id="stable">Loading...</div>
  </div>

  <div class="section">
    <div class="section-title">Heaven's Vault Portfolio</div>
    <div id="heaven">Loading...</div>
  </div>

  <div class="section">
    <div class="section-title">üèÜ Winnings</div>
    <div id="winnings">¬£0.00</div>
  </div>

  <canvas id="heavenChart" width="200" height="100"></canvas>
  <canvas id="stableChart" width="200" height="100"></canvas>

  <button onclick="resetWinnings()" style="background:#222;color:#00ffff;border:1px solid #00cccc;padding:5px 10px;margin-top:20px;">Reset Winnings</button>

  <script>
    const START_STABLE = 5000;
    let winnings = parseFloat(localStorage.getItem("winnings")) || 0;
    let startHeaven = parseFloat(localStorage.getItem("startHeaven")) || 5000;

    const stableTokens = {
      'USDE': 'ethena-usde',
      'RAI': 'rai',
      'FRAX': 'frax',
      'ALUSD': 'alchemix-usd',
      'LUSD': 'liquity-usd'
    };

    const heavenTokens = {
      'ETHENA': 'ethena-usde',
      'PENDLE': 'pendle',
      'GMX': 'gmx',
      'LIT': 'litentry',
      'METH': 'mantle-staked-ether'
    };

    const debugBox = document.createElement('div');
    debugBox.style.fontSize = '12px';
    debugBox.style.color = '#888';
    debugBox.style.marginTop = '20px';
    document.body.appendChild(debugBox);

    let heavenHistory = [];
    let stableHistory = [];

    async function fetchPrices(tokens) {
      const ids = Object.values(tokens).join(',');
      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=gbp`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!Object.keys(data).length) throw new Error("Empty price data");
        return data;
      } catch (err) {
        console.error("‚ùå Fetch error:", err);
        return {};
      }
    }

    function calculate(tokens, prices, start, label) {
      const split = start / Object.keys(tokens).length;
      let total = 0;
      const html = [];

      for (const [symbol, id] of Object.entries(tokens)) {
        const price = prices[id]?.gbp ?? 1;
        const qty = split / price;
        const value = qty * price;
        total += value;
        html.push(`<div class="box">${symbol} Price<br>¬£${price.toFixed(6)}</div>`);
      }

      const gain = total - start;
      const gainClass = gain >= 0 ? 'positive' : 'negative';
      return {
        html: `
          <div class="box">Total Value<br>¬£${total.toFixed(2)}</div>
          ${html.join('')}
          <div class="gain ${gainClass}">Gain<br>¬£${gain.toFixed(2)}</div>
        `,
        total,
        gain
      };
    }

    function updateChart(chart, label, data) {
      chart.data.labels.push(label);
      chart.data.datasets[0].data.push(data);
      if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }

    let heavenChart = new Chart(document.getElementById('heavenChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: "Heaven's Vault (¬£)",
          borderColor: '#ff00ff',
          data: []
        }]
      },
      options: {
        plugins: { legend: { labels: { color: '#00ffff' } } },
        scales: {
          x: { ticks: { color: '#888' } },
          y: { ticks: { color: '#888' } }
        }
      }
    });

    let stableChart = new Chart(document.getElementById('stableChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: "Stablecoin Vault (¬£)",
          borderColor: '#00ffcc',
          data: []
        }]
      },
      options: {
        plugins: { legend: { labels: { color: '#00ffff' } } },
        scales: {
          x: { ticks: { color: '#888' } },
          y: { ticks: { color: '#888' } }
        }
      }
    });

    async function updateVault() {
      try {
        const stablePrices = await fetchPrices(stableTokens);
        const heavenPrices = await fetchPrices(heavenTokens);

        const stableData = calculate(stableTokens, stablePrices, START_STABLE, "Stablecoin");
        const heavenData = calculate(heavenTokens, heavenPrices, startHeaven, "Heaven");

        if (heavenData.gain >= 50) {
          winnings += heavenData.gain;
          startHeaven = heavenData.total;
          localStorage.setItem("winnings", winnings.toFixed(2));
          localStorage.setItem("startHeaven", heavenData.total.toFixed(2));
          console.log(`üéâ Winnings triggered: +¬£${heavenData.gain.toFixed(2)}`);
        }

        document.getElementById("stable").innerHTML = stableData.html;
        document.getElementById("heaven").innerHTML = heavenData.html;
        document.getElementById("winnings").innerHTML = `¬£${winnings.toFixed(2)}`;
        document.getElementById("timestamp").textContent = "Last updated: " + new Date().toUTCString();

        updateChart(heavenChart, new Date().toLocaleTimeString(), heavenData.total);
        updateChart(stableChart, new Date().toLocaleTimeString(), stableData.total);

        debugBox.innerText = '‚úÖ Prices loaded and vaults updated successfully.';
      } catch (e) {
        console.error('üî• updateVault() error:', e);
        debugBox.innerText = '‚ö†Ô∏è Failed to load data. Try again later.';
        document.getElementById("heaven").innerHTML = '<div class="box">Failed to load Heaven‚Äôs Vault data.</div>';
      }
    }

    function resetWinnings() {
      winnings = 0;
      startHeaven = 5000;
      localStorage.removeItem("winnings");
      localStorage.removeItem("startHeaven");
      updateVault();
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateVault();
      setInterval(updateVault, 1000);
    });
  </script>
</body>
</html>
